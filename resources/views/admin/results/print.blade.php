<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Election Results - {{ $election->title }}</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 12pt; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #000; padding: 6px; text-align: left; }
        th { background: #eee; }
        .winner-row { background: #b6d7a8 !important; font-weight: bold; }
        .center { text-align: center; }
    </style>
</head>
<body>
    <h2 style="text-align:center;">{{ $election->title }}<br>Election Results</h2>
    <p style="text-align:center;">{{ \Carbon\Carbon::parse($election->start_date)->format('F d, Y') }} - {{ \Carbon\Carbon::parse($election->end_date)->format('F d, Y') }}</p>
    <p style="text-align:center;">Generated: {{ date('F d, Y h:i A') }}</p>
    <table>
        <tr>
            <td><strong>Total Registered Voters:</strong></td>
            <td>{{ $totalVoters }}</td>
            <td><strong>Votes Cast:</strong></td>
            <td>{{ $votedCount }}</td>
            <td><strong>Voter Turnout:</strong></td>
            <td>{{ $totalVoters > 0 ? round(($votedCount / $totalVoters) * 100, 2) : 0 }}%</td>
        </tr>
    </table>
    @foreach($results as $result)
        <h3>{{ $result['position']->name }}</h3>
        @php
            $grouped = collect($result['candidates'])->groupBy(function($item) {
                $course = $item['candidate']->course ?? 'No Course';
                $year = $item['candidate']->year_level ?? 'N/A';
                return $course . ' - Year ' . $year;
            });
        @endphp
        @foreach($grouped as $groupKey => $candidates)
            <h4 style="margin-bottom:2px;">{{ $groupKey }}</h4>
            <table>
                <thead>
                    <tr>
                        <th class="center">Rank</th>
                        <th>Candidate Name</th>
                        <th>Party</th>
                        <th class="center">Votes</th>
                        <th class="center">%</th>
                    </tr>
                </thead>
                <tbody>
                    @if($candidates->isEmpty() && $result['abstain_votes'] == 0)
                        <tr><td colspan="5" class="center">No votes cast for this group</td></tr>
                    @else
                        @foreach($candidates as $i => $candidateResult)
                            @php
                                $percentage = $result['total_votes'] > 0 ? round(($candidateResult['votes'] / $result['total_votes']) * 100, 2) : 0;
                            @endphp
                            <tr class="{{ $i === 0 && $candidateResult['votes'] > 0 ? 'winner-row' : '' }}">
                                <td class="center">{{ $i + 1 }}</td>
                                <td>{{ $candidateResult['candidate']->full_name }}</td>
                                <td>{{ $candidateResult['candidate']->party ? $candidateResult['candidate']->party->acronym : 'No Party' }}</td>
                                <td class="center">{{ $candidateResult['votes'] }}</td>
                                <td class="center">{{ $percentage }}%</td>
                            </tr>
                        @endforeach
                    @endif
                </tbody>
            </table>
        @endforeach
        @if($result['abstain_votes'] > 0)
            @php
                $abstainPercentage = $result['total_votes'] > 0 ? round(($result['abstain_votes'] / $result['total_votes']) * 100, 2) : 0;
            @endphp
            <table>
                <tr>
                    <td class="center">-</td>
                    <td><strong>ABSTAIN</strong></td>
                    <td>-</td>
                    <td class="center">{{ $result['abstain_votes'] }}</td>
                    <td class="center">{{ $abstainPercentage }}%</td>
                </tr>
                <tr style="font-weight:bold; background:#eee;">
                    <td colspan="3" class="center">TOTAL VOTES</td>
                    <td class="center">{{ $result['total_votes'] }}</td>
                    <td class="center">100%</td>
                </tr>
            </table>
        @endif
    @endforeach
    <p style="text-align:center; font-size:10pt; margin-top:40px;">This is an official document generated by the ACLC College Electronic Voting System<br>Printed on {{ date('F d, Y \a\t h:i A') }}</p>
</body>
</html>
